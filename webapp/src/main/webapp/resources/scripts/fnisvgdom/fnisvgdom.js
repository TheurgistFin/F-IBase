if(!window.fi){window.fi={}}if(!window.fi.foyt){window.fi.foyt={}}if(!window.fi.foyt.svg){window.fi.foyt.svg={}}if(!window.fi.foyt.svg.svgdom){window.fi.foyt.svg.svgdom={}}fi.foyt.svg.svgdom.FNISVGDocument=Class.create({initialize:function(){this.svgNamespace="http://www.w3.org/2000/svg";this.elements=null;this._viewbox=null;this._svgNode=document.createElementNS(this.svgNamespace,"svg");this._svgDocument=this._svgNode.ownerDocument;this._svgWindow=window;this._svgNode.setAttribute("xmlns:svg",this.svgNamespace);this._svgNode.setAttribute("xmlns:fni","http://www.foyt.fi/fnins");this._svgNode.setAttribute("xmlns",this.svgNamespace);this._initLayers()},getCurrentLayer:function(){return this._currentLayer},setCurrentLayer:function(a){this._currentLayer=a;this.fire("currentLayerChanged",{layer:a})},getLayers:function(){var a=new Array();var c=this._getElementChildNodes(this.getRootElement());for(var b=0;b<c.length;b++){var d=c[b];if(d){if((d.tagName.toUpperCase()=="G")&&(d.getAttribute("fnigrouptype")=="layer")){a.push(c[b])}}}return a},raiseLayer:function(b){var c=this.getLayers();for(var a=0;a<c.length;a++){if(c[a]==b){if(a<(c.length-2)){this.getRootElement().insertBefore(b,c[a+2])}else{this.getRootElement().appendChild(b)}this.fire("layerRaised",{layer:b});break}}},lowerLayer:function(b){var c=this.getLayers();for(var a=0;a<c.length;a++){if(c[a]==b){if(a>0){this.getRootElement().insertBefore(b,c[a-1])}this.fire("layerLowered",{layer:b});break}}},getRootElement:function(){return this._svgNode},getBackgroundGroup:function(){return this._background},createElement:function(a){return this._svgDocument.createElementNS(this.svgNamespace,a)},importElement:function(b){try{return this._svgDocument.importNode(b,false)}catch(c){var d=this.createElement(b.tagName);for(var a=0;a<b.attributes.length;a++){d.setAttribute(b.attributes[a].name,b.attributes[a].value)}return d}},appendElement:function(a,b){if(this.elements==null){this.elements=new Array()}this.elements.push(b);if(a==null){this.getRootElement().appendChild(b)}else{a.appendChild(b)}},appendTemporaryElement:function(a){this.getRootElement().appendChild(a);a._temporary=true},removeTemporaryElement:function(a){if(a!=null){if(a.parentNode!=null){a.parentNode.removeChild(a)}else{addDebugText("Could not remove temporary node "+a.tagName+", cannot find parent...")}}},removeElement:function(b){for(var a=0;a<this.elements.length;a++){if(this.elements[a]==b){this.elements.splice(a,1);while(b.childNodes.length>0){this.removeElement(b.firstChild)}b.parentNode.removeChild(b);break}}},getElements:function(){return this.elements},setPageSize:function(c,b){var a=this.getRootElement();a.setAttribute("width",c);a.setAttribute("height",b)},setViewBox:function(c,e,d,b){this._viewbox={x:c,y:e,width:d,height:b};var a=this.getRootElement();a.setAttribute("viewBox",c+" "+e+" "+d+" "+b)},getViewBox:function(){if(this._viewbox==null){var b=this.getRootElement();var c=b.getAttribute("width");var a=b.getAttribute("height");this._viewbox={x:0,y:0,width:c,height:a}}return this._viewbox},getElementAt:function(a,f){var e=this.getElements();if(e!=null){for(var d=0;d<e.length;d++){var c=e[d];var b=c.getBBox();if((b.x<=a)&&(b.y<=f)&&((b.x+b.width)>=a)&&((b.y+b.height)>=f)){return c}}}return null},removeAllElements:function(){if(this.elements){while(this.elements.length>0){var a=this.elements.pop();a.parentNode.removeChild(a)}}},createLayer:function(b){var a=this.createElement("g");a.setAttribute("fnigrouptype","layer");a.setAttribute("fnilayertitle",b);this.getRootElement().appendChild(a);this.fire("layerCreated",{layer:a});return a},removeLayer:function(a){while(a.childNodes.length>0){this.removeElement(a.firstChild)}this.getRootElement().removeChild(a);this.fire("layerRemoved",{layer:a})},inspect:function(){return"[FNISVGDocument]"},getAsXML:function(d,a){var c=this._getSVGHeader();c+='<svg xmlns:fni="http://www.foyt.fi/fnins" xmlns:svg="'+this.svgNamespace+'" xmlns="'+this.svgNamespace+'" width="'+d+'" height="'+a+'">';var e=this.getLayers();for(var b=0;b<e.length;b++){c+=this._getElementAsXML(e[b])}return c+"</svg>"},_getElementChildNodes:function(a){return a.childNodes},_initLayers:function(){this._background=this.createElement("g");this._background.setAttribute("fnigrouptype","background");this.getRootElement().appendChild(this._background);this._currentLayer=null},_getSVGHeader:function(){return'<?xml version="1.0" encoding="UTF-8" standalone="no"?>'},_getElementAsXML:function(d){var a="";if(d._temporary!=true){if(FNISVGDOMUtils.isValidSVGElement(d)){a="<"+d.tagName;var f=FNISVGDOMUtils.getElementAttributeNames(this,d);for(var c=0;c<f.length;c++){var b=f[c];var g=d.getAttribute(f[c]);a+=" "+b+'="'+g+'"'}var h=this._getElementChildNodes(d);var e="";for(var c=0;c<h.length;c++){e+=this._getElementAsXML(h[c])}if(e==""){a+="/>"}else{a+=">"+e+"</"+d.tagName+">"}}}return a}});Object.extend(fi.foyt.svg.svgdom.FNISVGDocument.prototype,fni.events.FNIEventSupport);fi.foyt.svg.svgdom.FNISVGDOMUtils={getScreenBBox:function(b){var j=this.getTransformToElement(b,b.viewportElement);var d=b.getBBox();var e=[];var k=this._createSVGPoint(b,d.x,d.y);e.push(k.matrixTransform(j));k.x=d.x+d.width;k.y=d.y;e.push(k.matrixTransform(j));k.x=d.x+d.width;k.y=d.y+d.height;e.push(k.matrixTransform(j));k.x=d.x;k.y=d.y+d.height;e.push(k.matrixTransform(j));var g=this._createSVGPoint(b,e[0].x,e[0].y);var a=this._createSVGPoint(b,e[0].x,e[0].y);for(var c=1;c<e.length;c++){var h=e[c].x;var f=e[c].y;if(h<a.x){a.x=h}else{if(h>g.x){g.x=h}}if(f<a.y){a.y=f}else{if(f>g.y){g.y=f}}}return this._createSVGRect(b,a.x,a.y,g.x-a.x,g.y-a.y)},getElementSetScreenBBox:function(f){try{if(!f){return null}if(f.length>0){var b=FNISVGDOMUtils.getScreenBBox(f[0]);var a=b.x;var j=b.y;var h=b.x+b.width;var d=b.y+b.height;for(var c=1;c<f.length;c++){b=FNISVGDOMUtils.getScreenBBox(f[c]);a=Math.min(a,b.x);j=Math.min(j,b.y);h=Math.max(h,b.x+b.width);d=Math.max(d,b.y+b.height)}return this._createSVGRect(f[0],a,j,h-a,d-j)}return null}catch(g){throw new Error("FNISVGDOMUtils::getElementSetScreenBBox: "+g)}},createElementFromJSON:function(a,d){var e=(Object.isString(d))?d.evalJSON():d;var c=a.createElement(e.element);for(var b in e.attributes){c.setAttribute(b,e.attributes[b])}return c},removeIllegalAttributes:function(a,f){var g=this.getElementAttributeNames(a,f);for(var e=0;e<g.length;e++){var d=g[e];var h=false;var c=this._LegalElementAttributes[f.tagName];var b=c.length;while((b>0)&&(h==false)){b--;if(c[b]==d){h=true}}if(h==false){f.removeAttribute(d)}}},getElementAttributeNames:function(a,c){var d=new Array();for(var b=0;b<c.attributes.length;b++){d.push(c.attributes[b].name)}return d},isValidSVGElement:function(b){for(var a=0;a<this._ValidSVGElements.length;a++){if(this._ValidSVGElements[a]==b.tagName){return true}}return false},_createSVGPoint:function(c,b,d){var a=c.viewportElement.createSVGPoint();a.x=b;a.y=d;return a},_createSVGRect:function(c,b,f,d,a){var e=c.viewportElement.createSVGRect();e.x=b;e.y=f;e.width=d;e.height=a;return e},_LegalElementAttributes:{rect:["id","transform","style","x","y","rx","ry","width","height"],circle:["id","transform","style","cx","cy","r"],ellipse:["id","transform","style","cx","cy","rx","ry"],line:["id","transform","style","x1","y1","x2","y2"],polygon:["id","transform","style","points"],polyline:["id","transform","style","points"],path:["id","transform","style","d"],g:["id","transform","style","fnigrouptype","fnilayertitle"]},_ValidSVGElements:["rect","circle","ellipse","line","polyline","polygon","path","g","defs","linearGradient","radialGradient","stop"],getTransformToElement:function(b,a){return b.getTransformToElement(a)}};fi.foyt.svg.svgdom.FNISVGElementController=Class.create({initialize:function(){},moveBy:function(b,a,c){throw new Error("Element does not support moveBy operation")},moveTo:function(b,a,c){throw new Error("Element does not support moveTo operation")},resizeBy:function(b,a,c){throw new Error("Element does not support resizeBy operation")},resizeTo:function(b,a,c){throw new Error("Element does not support resizeTo operation")},rotateBy:function(b,a){throw new Error("Element does not support rotateBy operation")},rotateTo:function(b,a){throw new Error("Element does not support rotateTo operation")},supports:function(a){return false}});Object.extend(fi.foyt.svg.svgdom.FNISVGElementController,{OPERATION_MOVE:"move",OPERATION_RESIZE:"resize",OPERATION_ROTATE:"rotate"});fi.foyt.svg.svgdom.FNISVGCircleElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){}});fi.foyt.svg.svgdom.FNISVGEllipseElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){},moveTo:function(b,a,e){var d=parseFloat(b.getAttribute("rx"));if(isNaN(d)){d=0}var c=parseFloat(b.getAttribute("ry"));if(isNaN(c)){c=0}b.setAttribute("cx",a+d);b.setAttribute("cy",e+c)},moveBy:function(b,a,d){var c=b.getBBox();this.moveTo(b,c.x+a,c.y+d)},resizeTo:function(d,c,l){var k=parseFloat(d.getAttribute("rx"));if(isNaN(k)){k=0}var j=parseFloat(d.getAttribute("ry"));if(isNaN(j)){j=0}var g=parseFloat(d.getAttribute("cx"));if(isNaN(g)){g=0}var f=parseFloat(d.getAttribute("cy"));if(isNaN(f)){f=0}var b=g-k;var a=f-j;var i=c/2;var e=l/2;d.setAttribute("rx",i);d.setAttribute("ry",e);d.setAttribute("cx",b+i);d.setAttribute("cy",a+e)},resizeBy:function(c,b,a){var g=parseFloat(c.getAttribute("rx"));var e=parseFloat(c.getAttribute("ry"));var f=g*b;var d=e*a;this.moveBy(c,f-g,d-e);c.setAttribute("rx",f);c.setAttribute("ry",d)},supports:function(a){return((a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_MOVE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_RESIZE))}});fi.foyt.svg.svgdom.FNISVGLineElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){},moveTo:function(b,a,f){try{var d=b.getBBox();b.setAttributeNS(null,"x1",a+"px");b.setAttributeNS(null,"y1",f+"px");b.setAttributeNS(null,"x2",(d.width+a)+"px");b.setAttributeNS(null,"y2",(d.height+f)+"px")}catch(c){throw new Error("FNISVGLineElementController::moveTo: "+c)}},resizeTo:function(b,c,a){try{var f=b.getBBox();b.setAttributeNS(null,"x2",(f.x+c)+"px");b.setAttributeNS(null,"y2",(f.y+a)+"px")}catch(d){throw new Error("FNISVGLineElementController::resizeTo: "+d)}},moveBy:function(b,a,f){try{var d=b.getBBox();this.moveTo(b,d.x+a,d.y+f)}catch(c){throw new Error("FNISVGLineElementController::moveBy: "+c)}},resizeBy:function(c,b,h){try{var g=c.getBBox();var d=g.width*b;var a=g.height*h;this.resizeTo(c,d,a)}catch(f){throw new Error("FNISVGLineElementController::resizeBy: "+f)}},setLine:function(d,b,e,a,c){if(b){d.setAttributeNS(null,"x1",b+"px")}if(e){d.setAttributeNS(null,"y1",e+"px")}if(a){d.setAttributeNS(null,"x2",a+"px")}if(c){d.setAttributeNS(null,"y2",c+"px")}},supports:function(a){return((a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_MOVE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_RESIZE))}});fi.foyt.svg.svgdom.FNISVGPolygonElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){}});fi.foyt.svg.svgdom.FNISVGPolylineElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){}});fi.foyt.svg.svgdom.FNISVGRectElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){},moveBy:function(b,a,f){try{var d=b.getBBox();this.moveTo(b,d.x+a,d.y+f)}catch(c){throw new Error("FNISVGRectElementController::moveBy: "+c)}},moveTo:function(b,a,d){try{b.setAttribute("x",a);b.setAttribute("y",d)}catch(c){throw new Error("FNISVGRectElementController::moveTo: "+c)}},resizeBy:function(c,b,a){try{var f=c.getBBox();this.resizeTo(c,f.width*b,f.height*a)}catch(d){throw new Error("FNISVGRectElementController::resizeBy: "+d)}},resizeTo:function(b,c,a){try{b.setAttribute("width",c);b.setAttribute("height",a)}catch(d){throw new Error("FNISVGRectElementController::resizeTo: "+d)}},supports:function(a){return((a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_MOVE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_RESIZE))}});fi.foyt.svg.svgdom.FNISVGPathElementSegment=Class.create({initialize:function(b,c,a){this.command=b;this.absolute=c;this.parameters=a==null?new Array():a},addParameter:function(a,b){this.parameters.push({x:a,y:b})},getParameters:function(){return this.parameters},isAbsolute:function(){return this.absolute},toString:function(){var a=(this.isAbsolute()?this.command:this.command.toLowerCase())+((this.parameters.length>0)?this.parameters[0].x+" "+this.parameters[0].y:"");for(var b=1;b<this.parameters.length;b++){a+=" "+this.parameters[b].x+" "+this.parameters[b].y}return a}});fi.foyt.svg.svgdom.FNISVGPathParser=Class.create({initialize:function(){this.commands={M:["x","y"],L:["x","y"],H:["x"],V:["y"],C:["x1","y1","x2","y2","x","y"],S:["x2","y2","x","y"],Q:["x1","y1","x","y"],T:["x","y"],A:["rx","ry","x-axis-rotation","large-arc-flag","sweep-flag","x","y"],Z:[]}},parsePath:function(e){var o=e.getAttribute("d");if((o==null)||(o.blank())){return new Array()}var k=o.replace(/,/g," ");var l=k.split(" ");var g=new Array();var h=null;var f=true;var n=null;var m=null;for(var c=0;c<l.length;c++){var a=l[c];if(a.charAt(0).search("[a-zA-Z]")==0){var j=a.charAt(0).search("[A-Z]")==0;var b=j?a.charAt(0):a.charAt(0).toLowerCase();h=new FNISVGPathElementSegment(b,j);g.push(h);pIndex=0;if(a.length>1){n=new Number(a.substring(1));f=false}}else{f=!f;if(f==true){m=new Number(a)}else{n=new Number(a)}}if((n!=null)&&(m!=null)){h.addParameter(n,m);n=null;m=null}}return g}});fi.foyt.svg.svgdom.FNISVGPathElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){this.pathParser=new fi.foyt.svg.svgdom.FNISVGPathParser()},getPathSegmentsObject:function(a){if(a.segments==null){a.segments=this.pathParser.parsePath(a)}return a.segments},appendSegment:function(a,b){this.getPathSegmentsObject(a).push(b);this.markPathChanged(a)},getSegments:function(a){return this.getPathSegmentsObject(a)},markPathChanged:function(a){a.pathChanged=true},updatePath:function(b){if((b.segments!=null)&&(b.pathChanged==true)){if(b.segments.length>0){var c=b.segments[0].toString();for(var a=1;a<b.segments.length;a++){c+=" "+b.segments[a].toString()}b.setAttributeNS(null,"d",c)}b.pathChanged=false}},reparsePath:function(a){a.segments=this.pathParser.parsePath(a);this.markPathChanged(a)},moveBy:function(b,k,h){try{var d=this.getSegments(b);for(var c=0;c<d.length;c++){var f=d[c];var m=f.getParameters();for(var a=0;a<m.length;a++){var l=m[a];l.x+=k;l.y+=h}}b.pathChanged=true;this.updatePath(b)}catch(g){throw new Error("FNISVGPathElementController::moveBy: "+g)}},moveTo:function(b,a,f){try{var d=b.getBBox();this.moveBy(b,a-d.x,f-d.y)}catch(c){throw new Error("FNISVGPathElementController::moveTo: "+c)}},resizeTo:function(d,f,a){try{var h=d.getBBox();if((h.width>0)&&(h.height>0)){var c=f/h.width;var b=a/h.height;this.resizeBy(d,c,b)}}catch(g){throw new Error("FNISVGPathElementController::resizeTo: "+g)}},resizeBy:function(c,n,m){try{var b=c.getBBox();var h=(b.x*n)-b.x;var o=(b.y*m)-b.y;var f=this.getSegments(c);for(var d=0;d<f.length;d++){var g=f[d];var p=g.getParameters();for(var a=0;a<p.length;a++){var l=p[a];l.x=(l.x*n)-h;l.y=(l.y*m)-o}}c.pathChanged=true;this.updatePath(c)}catch(k){throw new Error("FNISVGPathElementController::resizeBy: "+k)}},rotateBy:function(d,a,r,q){try{var b=Math.sin(a);var g=Math.cos(a);var h=this.getSegments(d);for(var f=0;f<h.length;f++){var k=h[f];var p=k.getParameters();for(var c=0;c<p.length;c++){var o=p[c];var n=parseFloat(o.x);var m=parseFloat(o.y);o.x=r+g*(n-r)-b*(m-q);o.y=q+b*(n-r)+g*(m-q)}}d.pathChanged=true;this.updatePath(d)}catch(l){throw new Error("FNISVGPathElementController::rotateBy: "+l)}},supports:function(a){return((a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_MOVE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_RESIZE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_ROTATE))}});fi.foyt.svg.svgdom.FNISVGGroupElementController=Class.create(fi.foyt.svg.svgdom.FNISVGElementController,{initialize:function($super){},moveBy:function(c,a,f){try{var b=FNISVGDOMUtils.getTransformToElement(c,c.viewportElement);b=b.translate(a/b.a,f/b.d);c.setAttribute("transform","matrix("+[b.a,b.b,b.c,b.d,b.e,b.f].join(" ")+")")}catch(d){throw new Error("FNISVGGroupElementController::moveBy: "+d)}},moveTo:function(b,a,f){try{var d=FNISVGDOMUtils.getScreenBBox(b);this.moveBy(b,a-d.x,f-d.y)}catch(c){throw new Error("FNISVGGroupElementController::moveTo: "+c)}},resizeBy:function(f,d,b){try{if((d!=1)&&(b!=1)){var h=f.getBBox();var a=FNISVGDOMUtils.getTransformToElement(f,f.viewportElement).scaleNonUniform(d,b);var c="matrix("+[a.a,a.b,a.c,a.d,a.e,a.f].join(",")+") translate("+[(h.x/d)-h.x,(h.y/b)-h.y]+")";f.setAttribute("transform",c)}}catch(g){throw new Error("FNISVGGroupElementController::resizeBy: "+g)}},resizeTo:function(b,c,a){try{var f=FNISVGDOMUtils.getScreenBBox(b);this.resizeBy(b,c/f.width,a/f.height)}catch(d){throw new Error("FNISVGGroupElementController::resizeTo: "+d)}},supports:function(a){return((a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_MOVE)||(a==fi.foyt.svg.svgdom.FNISVGElementController.OPERATION_RESIZE))}});fi.foyt.svg.svgdom.FNISVGElementControllerVaultClass=Class.create({initialize:function(){this._elementControllers=new Hash();this._registerElementController("rect",new fi.foyt.svg.svgdom.FNISVGRectElementController());this._registerElementController("circle",new fi.foyt.svg.svgdom.FNISVGCircleElementController());this._registerElementController("ellipse",new fi.foyt.svg.svgdom.FNISVGEllipseElementController());this._registerElementController("line",new fi.foyt.svg.svgdom.FNISVGLineElementController());this._registerElementController("polygon",new fi.foyt.svg.svgdom.FNISVGPolygonElementController());this._registerElementController("polyline",new fi.foyt.svg.svgdom.FNISVGPolylineElementController());this._registerElementController("path",new fi.foyt.svg.svgdom.FNISVGPathElementController());this._registerElementController("g",new fi.foyt.svg.svgdom.FNISVGGroupElementController())},getElementControllerFor:function(a){if(a!=null){return this.getElementController(a.tagName.toUpperCase())}else{throw new Error("Cannot return element controller for null element")}},getElementController:function(a){var b=this._elementControllers.get(a.toUpperCase());if(!b){throw new Error("Could not find elementcontroller for: "+a)}else{return b}},_registerElementController:function(a,b){this._elementControllers.set(a.toUpperCase(),b)}});window._svgElementControllerVault=null;window.getSVGElementControllerVault=function(){if(!window._svgElementControllerVault){window._svgElementControllerVault=new fi.foyt.svg.svgdom.FNISVGElementControllerVaultClass()}return window._svgElementControllerVault};